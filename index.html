<!DOCTYPE html>
<html>
<head>
    <title>mpv-remote-ws</title>
    <style type="text/css">
    </style>
</head>
<body>
<h1 id="title"></h1>
<p id="pos"></p>
<p>idle: <span id="idle"></span></p>
<div id="filebrowser"></div>
<p id="remote"></p>
<script>
// websocket init
var ws_req_id = 0;
var ws_onmessage_handlers = {};

var ws = new WebSocket('ws://' + window.location.host + '/ws');

ws.onopen = function(){
    filebrowser.open(['E:\\', 'torrent']);
};

ws.onmessage = function(ev){
    var response = JSON.parse(ev.data);
    if (response.id in ws_onmessage_handlers) {
        ws_onmessage_handlers[response.id](response.result);
        if (typeof response.id === 'number')
            delete ws_onmessage_handlers[response.id];
    }
};

ws.onclose = function(ev){

};

ws.onerror = function(ev){

};

// mpv commands
var mp = {
    get_property: function(name, cb, _native) {
        var method = 'get_property';
        if (_native) method += '_native';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, [name]);
    },

    get_property_native: function(name, cb) {
        this.get_property(name, cb, true);
    },

    set_property: function(name, val, cb) {
        var method = 'set_property';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, [name, val]);
    },

    commandv: function(params, cb) {
        var method = 'commandv';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, params);
    },

    play_file: function(path) {
        var method = 'play_file';
        this._send_message(method, path);
    },

    pause: function() {
        this.commandv(['cycle', 'pause']);
    },

    stop: function() {
        this.commandv(['stop']);
    },

    cycle_aspect: function() {
        this.commandv(['osd-msg', 'cycle-values', 'video-aspect', '16:9', '4:3', '2.35:1', '-1']);
    },

    set_vol: function(val) {
        this.commandv(['osd-msg-bar', 'set', 'volume', val]);
    },

    seek: function(seconds) {
        this.commandv(['osd-msg-bar', 'seek', seconds]);
    },

    chapter: function(amount) {
        this.commandv(['osd-msg-bar', 'add', 'chapter', amount]);
    },

    chapter_next: function() {
        this.chapter(1);
    },

    chapter_prev: function() {
        this.chapter(-1);
    },

    subdelay: function(seconds) {
        this.commandv(['osd-msg', 'add', 'sub-delay', seconds]);
    },

    audiodelay: function(seconds) {
        this.commandv(['osd-msg', 'add', 'audio-delay', seconds]);
    },

    cycle_sub: function() {
        this.commandv(['osd-msg', 'cycle', 'sub']);
    },

    cycle_audio: function() {
        this.commandv(['osd-msg', 'cycle', 'audio']);
    },

    toggle_drc: function() {
        this.commandv(['osd-msg', 'af', 'toggle', 'drc']);
    },

    _send_message: function(method, params) {
        ws.send(JSON.stringify({
            method: 'mpv_command',
            params: {
                method: method,
                params: params
            },
            id: ws_req_id
        }));
        ws_req_id += 1;
    }
}

// UI
var sorting = function(attr, reverse) {
    return function(a, b) {
        if (reverse) b = [a, a = b][0];
        if (attr == 'path') {
            a = a.path[a.path.length - 1];
            b = b.path[b.path.length - 1];
        }
        else if (attr == 'modified') {
            a = a.modified;
            b = b.modified;
        }
        if (a < b)
            return -1;
        if (b < a)
            return 1;
        return 0;
    }
}

var filebrowser = {
    path: [],
    content: [],

    open: function(path) {
        filebrowser.get_folder_content(path, filebrowser.render);
    },

    get_folder_content: function(path, cb) {
        ws_onmessage_handlers[ws_req_id] = cb;
        ws.send(JSON.stringify({
            method: 'folder_content',
            params: path,
            id: ws_req_id
        }));
        ws_req_id += 1;
    },

    render: function(content) {
        filebrowser.path = content.path;
        filebrowser.content = content.content;

        var files = filebrowser.content.filter(function(i) {
            return i.type == 'file';
        }).sort(sorting('path'));

        var folders = filebrowser.content.filter(function(i) {
            return i.type == 'dir';
        }).sort(sorting('modified', true));

        var sorted_content = [];
        var first = 'folders';
        if (first == 'folders') {
            sorted_content = folders.concat(files);
        }
        else if (first == 'files') {
            sorted_content = files.concat(folders);
        }


        var filebrowser_element = document.getElementById('filebrowser');
        filebrowser_element.innerHTML = '';

        var path_listing = document.createElement('ul');
        var dir_listing = document.createElement('ul');
        filebrowser_element.appendChild(path_listing);
        filebrowser_element.appendChild(dir_listing);

        var activate_path_link = function(link, i) {
            link.onclick = function() {
                filebrowser.open(filebrowser.path.slice(0, i + 1));
                return false;
            }
        }

        for (var i = 0; i < filebrowser.path.length; i++) {
            var link = document.createElement('a');
            link.href = '#';
            link.innerHTML = filebrowser.path[i];
            activate_path_link(link, i);
            var li = document.createElement('li');
            li.appendChild(link);
            path_listing.appendChild(li);
        }

        sorted_content.forEach(function(i) {
            var link = document.createElement('a');
            link.href = '#';
            link.innerHTML = i.path[i.path.length - 1];
            link.onclick = function() {
                if (i.type == 'file')
                    mp.play_file(i.path);
                else if (i.type == 'dir')
                    filebrowser.open(i.path);
                return false;
            }
            var li = document.createElement('li');
            li.appendChild(link);
            dir_listing.appendChild(li);
        });
    },

    hide: function() {
        document.getElementById('filebrowser').innerHTML = '';
    }
}

var remote = {
    render: function() {
        document.getElementById('remote').innerHTML = 'TODO';
    },

    hide: function() {
        document.getElementById('remote').innerHTML = '';
    }
}

// other stuff
ws_onmessage_handlers['media-title'] = function(data) {
    document.getElementById('title').innerHTML = data;
}

ws_onmessage_handlers['time-pos'] = function(data) {
    document.getElementById('pos').innerHTML = data;
}

ws_onmessage_handlers['idle'] = function(data) {
    document.getElementById('idle').innerHTML = data;
}

var debug = function (text) {
    console.log(text);
}
</script>
</body>
</html>
