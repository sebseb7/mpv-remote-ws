<!DOCTYPE html>
<html>
<head>
    <title>mpv-remote-ws</title>
    <style type="text/css">
    </style>
</head>
<body>
<h1 id="title"></h1>
<p id="pos"></p>
<p>idle: <span id="idle"></span></p>
<script>
// websocket init
var ws_req_id = 0;
var ws_onmessage_handlers = {};

var ws = new WebSocket('ws://' + window.location.host + '/ws');

ws.onopen = function(){

};

ws.onmessage = function(ev){
    var response = JSON.parse(ev.data);
    if (response.id in ws_onmessage_handlers) {
        ws_onmessage_handlers[response.id](response.result);
        if (typeof response.id === 'number')
            delete ws_onmessage_handlers[response.id];
    }
};

ws.onclose = function(ev){

};

ws.onerror = function(ev){

};

// mpv commands
var mp = {
    get_property: function(name, cb, _native) {
        var method = 'get_property';
        if (_native) method += '_native';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, [name]);
    },

    get_property_native: function(name, cb) {
        get_property(name, cb, true);
    },

    set_property: function(name, val, cb) {
        var method = 'set_property';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, [val]);
    },

    commandv: function(params, cb) {
        var method = 'commandv';
        if (cb) ws_onmessage_handlers[ws_req_id] = cb;
        this._send_message(method, params);
    },

    play_file: function(path) {
        var method = 'play_file';
        this._send_message(method, path);
    },

    _send_message: function(method, params) {
        ws.send(JSON.stringify({
            method: 'mpv_command',
            params: {
                method: method,
                params: params
            },
            id: ws_req_id
        }));
        ws_req_id += 1;
    }
}

// path commands
var get_folder_content = function(path, cb) {
    ws_onmessage_handlers[ws_req_id] = cb;
    ws.send(JSON.stringify({
        method: 'folder_content',
        params: path,
        id: ws_req_id
    }));
    ws_req_id += 1;
}

// other stuff
ws_onmessage_handlers['media-title'] = function(data) {
    document.getElementById('title').innerHTML = data;
}

ws_onmessage_handlers['time-pos'] = function(data) {
    document.getElementById('pos').innerHTML = data;
}

ws_onmessage_handlers['idle'] = function(data) {
    document.getElementById('idle').innerHTML = data;
}

var debug = function (text) {
    console.log(text);
}
</script>
</body>
</html>
